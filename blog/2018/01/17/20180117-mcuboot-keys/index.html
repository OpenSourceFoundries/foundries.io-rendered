<!DOCTYPE html>
<html lang="en-us">

  <head>
  <meta charset="utf-8">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Using your own firmware signing keys with MCUBoot</title>
  <meta name="author" content="" />

  
  <meta name="keywords" content="microPlatform, osf, updates">	
  

  

  <meta name="generator" content="Hugo 0.31.1" />

  <link href='//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800' rel='stylesheet' type='text/css'>

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  
  <link href="https://opensourcefoundries.com/css/animate.css" rel="stylesheet">

  
  
    <link href="https://opensourcefoundries.com/css/style.default.css" rel="stylesheet" id="theme-stylesheet">
  


  
  <link href="https://opensourcefoundries.com/css/custom.css" rel="stylesheet">

  
  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
  <link rel="shortcut icon" href="https://opensourcefoundries.com/img/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="https://opensourcefoundries.com/img/apple-touch-icon.png" />
  

  <link href="https://opensourcefoundries.com/css/owl.carousel.css" rel="stylesheet">
  <link href="https://opensourcefoundries.com/css/owl.theme.css" rel="stylesheet">

  <link rel="alternate" href="https://opensourcefoundries.com/index.xml" type="application/rss+xml" title="Open Source Foundries, Ltd.">

  
  <meta property="og:title" content="Using your own firmware signing keys with MCUBoot" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/blog/2018/01/17/20180117-mcuboot-keys//" />
  <meta property="og:image" content="img/logo.png" />

</head>


  <body>

    <div id="all">

        <header>

          <div class="navbar-affixed-top" data-spy="affix" data-offset-top="200">

    <div class="navbar navbar-default" role="navigation" id="navbar">

        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand home" href="https://opensourcefoundries.com/">
                    <img src="https://opensourcefoundries.com/img/logo.png" alt="Using your own firmware signing keys with MCUBoot logo" class="hidden-xs hidden-sm">
                    <img src="https://opensourcefoundries.com/img/logo-small.png" alt="Using your own firmware signing keys with MCUBoot logo" class="visible-xs visible-sm">
                    <span class="sr-only">Using your own firmware signing keys with MCUBoot - go to homepage</span>
                </a>
                <div class="navbar-buttons">
                    <button type="button" class="navbar-toggle btn-template-main" data-toggle="collapse" data-target="#navigation">
                      <span class="sr-only">Toggle Navigation</span>
                        <i class="fa fa-align-justify"></i>
                    </button>
                </div>
            </div>
            

            <div class="navbar-collapse collapse" id="navigation">
                <ul class="nav navbar-nav navbar-right">
                  

                    
                    <li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Product <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                          
                            <li><a href="/product/#overview">Overview</a></li>
                          
                            <li><a href="/product/#linux-microplatform">Linux microPlatform</a></li>
                          
                            <li><a href="/product/#zephyr-microplatform">Zephyr microPlatform</a></li>
                          
                            <li><a href="/product/#lifetime-support">Lifetime Support</a></li>
                          
                            <li><a href="/product/#hardware">Hardware</a></li>
                          
                            <li><a href="/product/#pricing">Pricing</a></li>
                          
                        </ul>
                    
                  </li>
                  

                    
                        <li class="dropdown"><a href="/partners/">Partners</a>
                    
                  </li>
                  

                    
                        <li class="dropdown"><a href="/blog/">Blog</a>
                    
                  </li>
                  

                    
                    <li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">About <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                          
                            <li><a href="/about/#company">Company</a></li>
                          
                            <li><a href="/about/#investors">Investors</a></li>
                          
                            <li><a href="/about/#team">Team</a></li>
                          
                            <li><a href="/about/#community">Community</a></li>
                          
                            <li><a href="/about/#careers">Careers</a></li>
                          
                        </ul>
                    
                  </li>
                  

                    
                        <li>
                            <p class="btn btn-template-main btn-template-main-gettingstarted">
                                <a class="btn-template-main-gettingstarted" role="button" href="https://foundries.io">Get Started</a>
                            </p>
                    
                  </li>
                  
                </ul>
            </div>
            
            <div class="collapse clearfix" id="search">

                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search">
                        <span class="input-group-btn">

                    <button type="submit" class="btn btn-template-main"><i class="fa fa-search"></i></button>

                </span>
                    </div>
                </form>

            </div>
            

        </div>
    </div>
    

</div>




        </header>

        <div id="heading-breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1>Using your own firmware signing keys with MCUBoot</h1>
            </div>
        </div>
    </div>
</div>


        <div id="content">
            <div class="container">

                <div class="row">

                    

                    <div class="col-md-9" id="blog-post">

                        <p class="text-muted text-uppercase mb-small text-right">January 17, 2018</p>

                        <div id="post-content">
                          <p>Secure firmware over the air (FOTA) updates are a key <a href="https://opensourcefoundries.com/product/#zephyr-microplatform">Zephyr microPlatform</a> feature. This post explains how to use your own firmware signing key pair to secure the boot process on your devices.
</p>

<h1 id="boot-process-overview">Boot Process Overview</h1>

<p>When your Zephyr microPlatform device boots, <a href="https://mcuboot.com/">MCUBoot</a> checks for a cryptographically signed firmware update, then installs and runs it if one is available. Simplified, the boot process looks like this:</p>

<p><img src="../../../../../img/blog/mcuboot-boot.png" alt="Zephyr microPlatform Boot Diagram" /></p>

<p>The firmware update signature check uses a public key stored in the MCUBoot binary running on the device. MCUBoot checks that the firmware update is signed by the corresponding private key before booting it. This mitigates against attacks which try to boot untrusted firmware on your device.</p>

<p>Think of the data being stored in your device&rsquo;s flash like this:</p>

<p><img src="../../../../../img/blog/device-flash.png" alt="Device flash" /></p>

<p>To make getting started easy, the MCUBoot repository&rsquo;s source code contains a default public key, along with its private key in a data file. Since the private key is not secret, this is not secure to use in production. When deploying your devices, you need to use your own key pair, with a private key that you must keep secret.</p>

<p>(If you&rsquo;re new to these ideas, check out the <a href="https://en.wikipedia.org/wiki/Public-key_cryptography">Public-key cryptography</a> and <a href="https://en.wikipedia.org/wiki/Digital_signature">Digital signature</a> pages on Wikipedia.)</p>

<h1 id="requirements">Requirements</h1>

<p>You must have the Zephyr microPlatform installed on your system. See the installation instructions here in the <a href="https://foundries.io/docs/latest/">microPlatforms documentation</a> for instructions if you haven&rsquo;t done that.</p>

<p>Any board supported by the Zephyr microPlatform can be used with these instructions.</p>

<h1 id="generate-keys">Generate Keys</h1>

<p>Run these commands from the Zephyr microPlatform installation directory.</p>

<p>MCUBoot provides tools which can create and manage your keys. This
section describes how to use them. For more details, including details on protecting your secret key with a password, see the file <code>mcuboot/docs/imgtool.md</code> in your Zephyr microPlatform installation directory.</p>

<p>The MCUBoot tools depend on the <a href="https://cryptography.io/">cryptography</a> module. Install it first; for example, using <code>pip3</code>:</p>

<pre><code>pip3 install --user cryptography
</code></pre>

<p>Now generate an RSA 2048 key pair (this is the default key type used by MCUBoot; if you configured MCUBoot differently, you need to adjust <code>-t</code> accordingly):</p>

<pre><code>./mcuboot/scripts/imgtool.py keygen -k my-secret-key.pem -t rsa-2048
</code></pre>

<p><strong>The contents of the file my-secret-key.pem are a secret. Guard it closely.</strong></p>

<p>Next, generate some C code containing the public key as an array:</p>

<pre><code>./mcuboot/scripts/imgtool.py getpub -k my-secret-key.pem
</code></pre>

<p>The output looks like this:</p>

<pre><code class="language-c">/* Autogenerated by imgtool.py, do not edit. */
const unsigned char rsa_pub_key[] = {
	0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x77, 0x88,
	/* [additional lines omitted] */
	0x99, 0xaa, 0xbb, 0xcc, 0xdd, 0xee,
};
const unsigned int rsa_pub_key_len = 270;
</code></pre>

<p>You will copy these values into the MCUBoot source code.</p>

<h1 id="copy-the-public-key-into-the-mcuboot-source-code">Copy the Public Key Into the MCUBoot Source Code</h1>

<p>Now open the file <code>mcuboot/boot/zephyr/keys.c</code> in your editor. Search for lines that look like this:</p>

<pre><code class="language-c">#if defined(MCUBOOT_SIGN_RSA)
const unsigned char root_pub_der[] = {
    0x30, 0x82, 0x01, 0x0a, 0x02, 0x82, 0x01, 0x01, 0x00, 0xd1, 0x06, 0x08,
    /* Additional lines omitted. */
    0xc9, 0x02, 0x03, 0x01, 0x00, 0x01
};
const unsigned int root_pub_der_len = 270;
}
</code></pre>

<p>Delete the elements of the <code>root_pub_der</code> array, and replace them with
the <code>imgtool.py</code> output, like this:</p>

<pre><code class="language-c">#if defined(MCUBOOT_SIGN_RSA)
const unsigned char root_pub_der[] = {
	0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x77, 0x88,
	/* [additional lines omitted] */
	0x99, 0xaa, 0xbb, 0xcc, 0xdd, 0xee,
};
const unsigned int root_pub_der_len = 270;
}
</code></pre>

<p><strong>Make sure to change the contents of <code>root_pub_der</code> only, not its name.</strong></p>

<p><strong>Make sure that the value of <code>root_pub_der_len</code> matches the <code>rsa_pub_key_len</code> generated by <code>imgtool</code>.</strong></p>

<p>Commit this change and ensure you preserve it.</p>

<h1 id="build-app-with-custom-mcuboot-image">Build App With Custom MCUBoot image</h1>

<p>You can now rebuild your Zephyr microPlatform application binary, along with a customized MCUBoot binary which trusts your public key. Here is an example building the <code>zephyr-fota-samples/dm-lwm2m</code> application for the <code>nrf52_blenano2</code> board using the <code>zmp</code> tool:</p>

<pre><code>./zmp build -K my-secret-key.pem -b nrf52_blenano2 zephyr-fota-samples/dm-lwm2m
</code></pre>

<p>The important files this generates are:</p>

<ul>
<li><p>A custom MCUBoot binary which trusts your public key in <code>outdir/zephyr-fota-samples/dm-lwm2m/nrf52_blenano2/mcuboot/zephyr/zephyr.bin</code>. Use this binary when flashing devices you are going to deploy to the field.</p></li>

<li><p>A Zephyr binary which is signed with your private key in <code>outdir/zephyr-fota-samples/dm-lwm2m/nrf52_blenano2/app/zephyr/dm-lwm2m-nrf52_blenano2-signed.bin</code>. You can distribute this binary in FOTA updates.</p></li>
</ul>

<p>To verify your setup, flash the custom MCUBoot to your board, along with the signed binary into the main firmware image area. For example, using the <code>zmp</code> tool:</p>

<pre><code>./zmp flash -b nrf52_blenano2 zephyr-fota-samples/dm-lwm2m
</code></pre>
                        </div>
                        
                        
                        <div id="comments">
                            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "osfoundries" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                        </div>
                        

                    </div>
                    

                    

                    

                    <div class="col-md-3">

                        

                        

<div class="panel panel-default sidebar-menu">

    <div class="panel-heading">
      <h3 class="panel-title">Search</h3>
    </div>

    <div class="panel-body">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" role="search">
            <div class="input-group">
                <input type="search" name="q" class="form-control" placeholder="Search">
                <input type="hidden" name="sitesearch" value="https://opensourcefoundries.com/">
                <span class="input-group-btn">
                    <button type="submit" class="btn btn-template-main"><i class="fa fa-search"></i></button>
                </span>
            </div>
        </form>
    </div>
</div>







<div class="panel panel-default sidebar-menu">

    <div class="panel-heading">
      <h3 class="panel-title">Categories</h3>
    </div>

    <div class="panel-body">
        <ul class="nav nav-pills nav-stacked">
            
            <li><a href="https://opensourcefoundries.com/categories/blockchain">blockchain (1)</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/categories/bluetooth">bluetooth (1)</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/categories/conferences">conferences (3)</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/categories/corporate">corporate (1)</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/categories/docker">docker (1)</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/categories/embedded">embedded (1)</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/categories/fota">fota (2)</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/categories/iot">iot (2)</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/categories/linux">linux (1)</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/categories/lwm2m">lwm2m (2)</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/categories/mcuboot">mcuboot (1)</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/categories/microplatform">microplatform (19)</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/categories/minutes">minutes (1)</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/categories/newsletter">newsletter (1)</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/categories/quickstart">quickstart (1)</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/categories/radio">radio (1)</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/categories/threats">threats (1)</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/categories/updates">updates (14)</a>
            </li>
            
        </ul>
    </div>
</div>








<div class="panel sidebar-menu">
    <div class="panel-heading">
      <h3 class="panel-title">Tags</h3>
    </div>

    <div class="panel-body">
        <ul class="tag-cloud">
            
            <li><a href="https://opensourcefoundries.com/tags/att"><i class="fa fa-tags"></i> att</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/ble"><i class="fa fa-tags"></i> ble</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/blockchain"><i class="fa fa-tags"></i> blockchain</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/bugs"><i class="fa fa-tags"></i> bugs</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/containers"><i class="fa fa-tags"></i> containers</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/crypto"><i class="fa fa-tags"></i> crypto</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/cve"><i class="fa fa-tags"></i> cve</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/decentralized"><i class="fa fa-tags"></i> decentralized</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/docker"><i class="fa fa-tags"></i> docker</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/general"><i class="fa fa-tags"></i> general</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/iot"><i class="fa fa-tags"></i> iot</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/k8s"><i class="fa fa-tags"></i> k8s</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/keys"><i class="fa fa-tags"></i> keys</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/kubernetes"><i class="fa fa-tags"></i> kubernetes</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/linux"><i class="fa fa-tags"></i> linux</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/lte"><i class="fa fa-tags"></i> lte</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/lwm2m"><i class="fa fa-tags"></i> lwm2m</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/mcuboot"><i class="fa fa-tags"></i> mcuboot</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/microplatform"><i class="fa fa-tags"></i> microplatform</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/open-source"><i class="fa fa-tags"></i> open-source</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/ota"><i class="fa fa-tags"></i> ota</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/radio"><i class="fa fa-tags"></i> radio</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/resin"><i class="fa fa-tags"></i> resin</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/security"><i class="fa fa-tags"></i> security</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/update"><i class="fa fa-tags"></i> update</a>
            </li>
            
            <li><a href="https://opensourcefoundries.com/tags/zephyr"><i class="fa fa-tags"></i> zephyr</a>
            </li>
            
        </ul>
    </div>
</div>






                        

                    </div>
                    

                    

                </div>
                

            </div>
            
        </div>
        

        <footer id="footer">
    <script src="js/cookie-message.js"></script>

    <div class="container">

        
        <div class="col-md-4 col-sm-6">
            <h4>About us</h4>

            We provide best-in-class software platforms with lifetime support for
    building and maintaining connected products, ranging from the smallest sensors to
    smart and edge devices. Our core products are Zephyr RTOS and Linux based microPlatforms,
    which provide product quality templates to build secure, OTA updatable, connected devices
    for industrial and consumer markets.

            <hr class="hidden-md hidden-lg hidden-sm">

        </div>
        
        

        <div class="col-md-4 col-sm-6">

              

        </div>
        

        
        <div class="col-md-4 col-sm-6">

          <h4>Contact</h4>

            <strong>Open Source Foundries Ltd.</strong>
        <br>Cambridge, UK
        <br><br><strong>Open Source Foundries Inc.</strong>
        <br>Boulder CO, USA
      </p>
      


            <a class="btn btn-template-main" role="button" href="/contact">Contact Us</a>

            <hr class="hidden-md hidden-lg hidden-sm">

        </div>
        
        

    </div>
    
</footer>







<div id="copyright">
    <div class="container">
        <div class="col-md-12">
            
            <p class="pull-left">Copyright 2018 Open Source Foundries Ltd. All rights reserved.</p>
            
            <p class="pull-right">
            </p>
        </div>
    </div>
</div>





    </div>
    

    
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-111281311-1', 'auto');
ga('send', 'pageview');
</script>

<script src="//code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js"></script>


<script src="https://opensourcefoundries.com/js/front.js"></script>


<script src="https://opensourcefoundries.com/js/owl.carousel.min.js"></script>


  </body>
</html>
